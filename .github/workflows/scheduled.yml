name: Scheduled Pipeline
permissions:
  contents: write

on:
  schedule:
    # Runs every 15 minutes at :00, :15, :30, :45
    # NOTE: GitHub Actions cron uses UTC time. Adjust if you need specific local times.
    - cron: '*/15 * * * *'
  # Allows manual trigger from the Actions tab
  workflow_dispatch:
    inputs:
      region:
        description: 'Optional: process only this region id (must match a key in REGION_SOURCES_JSON)'
        required: false
        type: string

jobs:
  run:
    name: Fetch upstream HTML per region
    runs-on: ubuntu-latest
    env:
      # Expose the secret JSON map {"regionId": "url", ...}
      REGION_SOURCES_JSON: ${{ secrets.REGION_SOURCES_JSON }}
      # Optional single-region override when manually dispatching
      REGION: ${{ github.event.inputs.region }}
      # Target branch to push data updates to
      TARGET_BRANCH: main
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-ms-playwright-${{ hashFiles('**/package-lock.json') }}

      - name: Ensure Playwright Chromium is installed
        run: npx --yes playwright install --with-deps chromium

      - name: Fetch HTML for each region (with Playwright fallback)
        shell: bash
        run: |
          set -euo pipefail
          echo "Started at $(date -u +"%Y-%m-%dT%H:%M:%SZ") (UTC)"

          # Basic validation
          if [ -z "${REGION_SOURCES_JSON:-}" ]; then
            echo "REGION_SOURCES_JSON is empty or not set. Ensure repository secret is configured." >&2
            # Do not fail the job hard; exit gracefully to avoid noisy failures while configuring
            exit 0
          fi

          mkdir -p outputs

          # Playwright and Chromium are installed once above (with caching). Using cached toolchain.

          # If REGION is set — pass it to the script; otherwise fetch all
          if [ -n "${REGION:-}" ]; then
            echo "[INFO] Running Playwright fetcher for region='$REGION'"
            node scripts/fetch_regions_playwright.mjs "$REGION" || true
          else
            echo "[INFO] Running Playwright fetcher for all regions"
            node scripts/fetch_regions_playwright.mjs || true
          fi

          # Always exit 0 to not fail the pipeline on partial fetch issues
          exit 0

      - name: Parse DisconSchedule.fact into JSON per region (skip failures)
        shell: bash
        run: |
          set -euo pipefail
          echo "[INFO] Parsing outputs/*.html into data/*.json via Node batch parser"
          # Respect REGION env if provided (limits to a single region)
          node scripts/batch_parse.mjs

      - name: Generate schedule images from JSON (all regions / GPV groups)
        shell: bash
        run: |
          set -euo pipefail
          echo "[INFO] Preparing to render images from data/*.json"
          # Playwright toolchain prepared earlier (cached); no reinstall needed here.

          # Respect REGION env if provided (limits to a single region)
          if [ -n "${REGION:-}" ]; then
            echo "[INFO] Rendering images only for region='${REGION}'"
            node scripts/batch_render.mjs --region "${REGION}"
          else
            echo "[INFO] Rendering images for all regions"
            node scripts/batch_render.mjs
          fi

      - name: Commit and push data/images updates (if any)
        if: github.ref_name == env.TARGET_BRANCH
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "[INFO] Preparing to commit changes in data/ and images/ to ${TARGET_BRANCH}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          # Ensure we are on the target branch
          git checkout "$TARGET_BRANCH"

          # Show current status under data/ and images/
          echo "[INFO] Changed files under data/ and images/ (working tree):"
          git status --porcelain data/ images/ || true

          # Stage JSON files and any rendered images
          git add data/*.json 2>/dev/null || true
          git add images/** 2>/dev/null || true

          # If nothing staged, skip
          if git diff --cached --quiet; then
            echo "[INFO] No changes detected under data/ or images/ — skipping commit"
            exit 0
          fi

          echo "[INFO] Staged files:"
          git diff --name-only --cached

          # Rebase latest remote before committing/pushing
          git pull --rebase origin "$TARGET_BRANCH" || true

          msg_region=${REGION:-all}
          commit_msg="data/images: update schedules and rendered images (region=${msg_region}) — run #${GITHUB_RUN_ID}"
          git commit -m "$commit_msg"

          # Retry push up to 3 times on race
          for attempt in 1 2 3; do
            if git push origin HEAD:"$TARGET_BRANCH"; then
              echo "[OK] Pushed data/images updates to $TARGET_BRANCH"
              exit 0
            fi
            echo "[WARN] Push failed (attempt $attempt). Rebasing and retrying..."
            git pull --rebase origin "$TARGET_BRANCH" || true
            sleep $((attempt*2))
          done

          echo "[ERROR] Failed to push changes after retries" >&2
          exit 1

      - name: Upload data JSON as artifact (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: data-json
          path: |
            data/*.json
          if-no-files-found: warn
